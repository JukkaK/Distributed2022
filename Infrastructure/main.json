{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.13.1.58284",
      "templateHash": "457452782516506674"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "westeurope",
      "metadata": {
        "description": "Location for resources. Default is West Europe."
      }
    },
    "buildtag": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    }
  },
  "variables": {
    "shortLocation": "[createObject('westeurope', 'we', 'northeurope', 'ne', 'eastus', 'eus')[parameters('location')]]",
    "projectName": "distributed",
    "dbName": "[format('cosmon-{0}-{1}-001', variables('projectName'), variables('shortLocation'))]",
    "aiName": "[format('appi-{0}-{1}-001', variables('projectName'), variables('shortLocation'))]",
    "planName": "[format('asp-{0}-{1}-001', variables('projectName'), variables('shortLocation'))]",
    "funcName": "[format('func-{0}-{1}-001', variables('projectName'), variables('shortLocation'))]",
    "egTopicNameFront": "[format('evgt-{0}-front-{1}-001', variables('projectName'), variables('shortLocation'))]",
    "egTopicNameDist": "[format('evgt-{0}-workers-{1}-001', variables('projectName'), variables('shortLocation'))]",
    "sbName": "[format('sb-{0}-{1}-001', variables('projectName'), variables('shortLocation'))]",
    "locations": [
      "westeurope",
      "northeurope",
      "eastus"
    ]
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[format('rg-{0}-data-{1}-002', variables('projectName'), variables('shortLocation'))]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[format('rg-{0}-backend-we-001', variables('projectName'))]",
      "location": "westeurope"
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[format('rg-{0}-backend-ne-001', variables('projectName'))]",
      "location": "northeurope"
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[format('rg-{0}-backend-eus-001', variables('projectName'))]",
      "location": "eastus"
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[format('rg-{0}-message-{1}-001', variables('projectName'), variables('shortLocation'))]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-{1}', variables('dbName'), parameters('buildtag'))]",
      "resourceGroup": "[format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "collection1Name": {
            "value": "warehouseitems"
          },
          "region": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "7097720587072771766"
            }
          },
          "parameters": {
            "cosmosDBAccountName": {
              "type": "string",
              "defaultValue": "[format('mongodb-{0}', uniqueString(resourceGroup().id))]",
              "metadata": {
                "description": "Cosmos DB account name"
              }
            },
            "collection1Name": {
              "type": "string",
              "metadata": {
                "description": "The name for the first Mongo DB collection"
              }
            },
            "region": {
              "type": "string",
              "defaultValue": "westeurope"
            },
            "secondaryRegion": {
              "type": "string",
              "defaultValue": "northeurope"
            },
            "tertiaryRegion": {
              "type": "string",
              "defaultValue": "eastus"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2022-08-15",
              "name": "[toLower(parameters('cosmosDBAccountName'))]",
              "location": "[parameters('region')]",
              "kind": "MongoDB",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "databaseAccountOfferType": "Standard",
                "enableAutomaticFailover": true,
                "enableMultipleWriteLocations": true,
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "locations": [
                  {
                    "locationName": "[parameters('region')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  },
                  {
                    "locationName": "[parameters('secondaryRegion')]",
                    "failoverPriority": 1,
                    "isZoneRedundant": false
                  },
                  {
                    "locationName": "[parameters('tertiaryRegion')]",
                    "failoverPriority": 2,
                    "isZoneRedundant": false
                  }
                ],
                "apiProperties": {
                  "serverVersion": "4.2"
                }
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}', toLower(parameters('cosmosDBAccountName')), parameters('cosmosDBAccountName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosDBAccountName')]"
                },
                "options": {
                  "autoscaleSettings": {
                    "maxThroughput": 1000
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', toLower(parameters('cosmosDBAccountName')))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/mongodbDatabases/collections",
              "apiVersion": "2022-05-15",
              "name": "[format('{0}/{1}/{2}', toLower(parameters('cosmosDBAccountName')), parameters('cosmosDBAccountName'), parameters('collection1Name'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('collection1Name')]",
                  "shardKey": {
                    "user_id": "Hash"
                  },
                  "indexes": [
                    {
                      "key": {
                        "keys": [
                          "_id"
                        ]
                      }
                    },
                    {
                      "key": {
                        "keys": [
                          "$**"
                        ]
                      }
                    },
                    {
                      "key": {
                        "keys": [
                          "product_name",
                          "product_amount"
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/mongodbDatabases', toLower(parameters('cosmosDBAccountName')), parameters('cosmosDBAccountName'))]"
              ]
            }
          ],
          "outputs": {
            "cs": {
              "type": "string",
              "value": "[listConnectionStrings(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDBAccountName')), '2022-05-15').connectionStrings[0].connectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('ai-{0}', parameters('buildtag'))]",
      "resourceGroup": "[format('rg-{0}-backend-we-001', variables('projectName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "791512746299033544"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            }
          },
          "variables": {
            "applicationInsightsName": "ai-distributed-we-001"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[variables('applicationInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "Request_Source": "rest"
              }
            }
          ],
          "outputs": {
            "aiKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', variables('applicationInsightsName')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}-backend-we-001', variables('projectName')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "dbapi",
      "resourceGroup": "[format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "cosmoscs": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag'))), '2020-10-01').outputs.cs.value]"
          },
          "aiKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag'))), '2020-10-01').outputs.aiKey.value]"
          },
          "appName": {
            "value": "dbapi"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "12892721415721390949"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "The name of the function app that you wish to create."
              }
            },
            "storageAccountType": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS"
              ],
              "metadata": {
                "description": "Storage Account type"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "runtime": {
              "type": "string",
              "defaultValue": "node",
              "allowedValues": [
                "node",
                "dotnet",
                "java"
              ],
              "metadata": {
                "description": "The language worker runtime to load in the function app."
              }
            },
            "cosmoscs": {
              "type": "secureString",
              "defaultValue": ""
            },
            "aiKey": {
              "type": "string"
            },
            "serviceBusConnectionString": {
              "type": "secureString",
              "defaultValue": ""
            }
          },
          "variables": {
            "shortLocation": "[createObject('westeurope', 'we', 'northeurope', 'ne', 'eastus', 'eus')[parameters('location')]]",
            "functionAppName": "[format('func-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
            "storageAccountName": "[format('stgdist{0}{1}001', parameters('appName'), variables('shortLocation'))]",
            "functionWorkerRuntime": "[parameters('runtime')]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-08-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('storageAccountType')]"
              },
              "kind": "Storage"
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-03-01",
              "name": "[format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(variables('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~14"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('aiKey')]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "[variables('functionWorkerRuntime')]"
                    },
                    {
                      "name": "CosmosDbConnectionString",
                      "value": "[parameters('cosmoscs')]"
                    },
                    {
                      "name": "serviceBusConnectionString",
                      "value": "[parameters('serviceBusConnectionString')]"
                    }
                  ],
                  "ftpsState": "FtpsOnly",
                  "minTlsVersion": "1.2"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag')))]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "backendWe",
      "resourceGroup": "[format('rg-{0}-backend-we-001', variables('projectName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "westeurope"
          },
          "cosmoscs": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag'))), '2020-10-01').outputs.cs.value]"
          },
          "serviceBusConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('sbName'), parameters('buildtag'))), '2020-10-01').outputs.serviceBusConnectionString.value]"
          },
          "aiKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag'))), '2020-10-01').outputs.aiKey.value]"
          },
          "appName": {
            "value": "backend"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "12892721415721390949"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "The name of the function app that you wish to create."
              }
            },
            "storageAccountType": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS"
              ],
              "metadata": {
                "description": "Storage Account type"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "runtime": {
              "type": "string",
              "defaultValue": "node",
              "allowedValues": [
                "node",
                "dotnet",
                "java"
              ],
              "metadata": {
                "description": "The language worker runtime to load in the function app."
              }
            },
            "cosmoscs": {
              "type": "secureString",
              "defaultValue": ""
            },
            "aiKey": {
              "type": "string"
            },
            "serviceBusConnectionString": {
              "type": "secureString",
              "defaultValue": ""
            }
          },
          "variables": {
            "shortLocation": "[createObject('westeurope', 'we', 'northeurope', 'ne', 'eastus', 'eus')[parameters('location')]]",
            "functionAppName": "[format('func-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
            "storageAccountName": "[format('stgdist{0}{1}001', parameters('appName'), variables('shortLocation'))]",
            "functionWorkerRuntime": "[parameters('runtime')]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-08-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('storageAccountType')]"
              },
              "kind": "Storage"
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-03-01",
              "name": "[format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(variables('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~14"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('aiKey')]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "[variables('functionWorkerRuntime')]"
                    },
                    {
                      "name": "CosmosDbConnectionString",
                      "value": "[parameters('cosmoscs')]"
                    },
                    {
                      "name": "serviceBusConnectionString",
                      "value": "[parameters('serviceBusConnectionString')]"
                    }
                  ],
                  "ftpsState": "FtpsOnly",
                  "minTlsVersion": "1.2"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag')))]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}-backend-we-001', variables('projectName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('sbName'), parameters('buildtag')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "backendNe",
      "resourceGroup": "[format('rg-{0}-backend-ne-001', variables('projectName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "northeurope"
          },
          "cosmoscs": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag'))), '2020-10-01').outputs.cs.value]"
          },
          "serviceBusConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('sbName'), parameters('buildtag'))), '2020-10-01').outputs.serviceBusConnectionString.value]"
          },
          "aiKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag'))), '2020-10-01').outputs.aiKey.value]"
          },
          "appName": {
            "value": "backend"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "12892721415721390949"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "The name of the function app that you wish to create."
              }
            },
            "storageAccountType": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS"
              ],
              "metadata": {
                "description": "Storage Account type"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "runtime": {
              "type": "string",
              "defaultValue": "node",
              "allowedValues": [
                "node",
                "dotnet",
                "java"
              ],
              "metadata": {
                "description": "The language worker runtime to load in the function app."
              }
            },
            "cosmoscs": {
              "type": "secureString",
              "defaultValue": ""
            },
            "aiKey": {
              "type": "string"
            },
            "serviceBusConnectionString": {
              "type": "secureString",
              "defaultValue": ""
            }
          },
          "variables": {
            "shortLocation": "[createObject('westeurope', 'we', 'northeurope', 'ne', 'eastus', 'eus')[parameters('location')]]",
            "functionAppName": "[format('func-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
            "storageAccountName": "[format('stgdist{0}{1}001', parameters('appName'), variables('shortLocation'))]",
            "functionWorkerRuntime": "[parameters('runtime')]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-08-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('storageAccountType')]"
              },
              "kind": "Storage"
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-03-01",
              "name": "[format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(variables('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~14"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('aiKey')]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "[variables('functionWorkerRuntime')]"
                    },
                    {
                      "name": "CosmosDbConnectionString",
                      "value": "[parameters('cosmoscs')]"
                    },
                    {
                      "name": "serviceBusConnectionString",
                      "value": "[parameters('serviceBusConnectionString')]"
                    }
                  ],
                  "ftpsState": "FtpsOnly",
                  "minTlsVersion": "1.2"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag')))]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}-backend-ne-001', variables('projectName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('sbName'), parameters('buildtag')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "backendEus",
      "resourceGroup": "[format('rg-{0}-backend-eus-001', variables('projectName'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "eastus"
          },
          "cosmoscs": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag'))), '2020-10-01').outputs.cs.value]"
          },
          "serviceBusConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('sbName'), parameters('buildtag'))), '2020-10-01').outputs.serviceBusConnectionString.value]"
          },
          "aiKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag'))), '2020-10-01').outputs.aiKey.value]"
          },
          "appName": {
            "value": "backend"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "12892721415721390949"
            }
          },
          "parameters": {
            "appName": {
              "type": "string",
              "metadata": {
                "description": "The name of the function app that you wish to create."
              }
            },
            "storageAccountType": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS"
              ],
              "metadata": {
                "description": "Storage Account type"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources."
              }
            },
            "runtime": {
              "type": "string",
              "defaultValue": "node",
              "allowedValues": [
                "node",
                "dotnet",
                "java"
              ],
              "metadata": {
                "description": "The language worker runtime to load in the function app."
              }
            },
            "cosmoscs": {
              "type": "secureString",
              "defaultValue": ""
            },
            "aiKey": {
              "type": "string"
            },
            "serviceBusConnectionString": {
              "type": "secureString",
              "defaultValue": ""
            }
          },
          "variables": {
            "shortLocation": "[createObject('westeurope', 'we', 'northeurope', 'ne', 'eastus', 'eus')[parameters('location')]]",
            "functionAppName": "[format('func-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
            "storageAccountName": "[format('stgdist{0}{1}001', parameters('appName'), variables('shortLocation'))]",
            "functionWorkerRuntime": "[parameters('runtime')]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-08-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('storageAccountType')]"
              },
              "kind": "Storage"
            },
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2021-03-01",
              "name": "[format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation'))]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Y1",
                "tier": "Dynamic"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2021-03-01",
              "name": "[variables('functionAppName')]",
              "location": "[parameters('location')]",
              "kind": "functionapp",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "siteConfig": {
                  "appSettings": [
                    {
                      "name": "AzureWebJobsStorage",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTAZUREFILECONNECTIONSTRING",
                      "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};EndpointSuffix={1};AccountKey={2}', variables('storageAccountName'), environment().suffixes.storage, listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2021-08-01').keys[0].value)]"
                    },
                    {
                      "name": "WEBSITE_CONTENTSHARE",
                      "value": "[toLower(variables('functionAppName'))]"
                    },
                    {
                      "name": "FUNCTIONS_EXTENSION_VERSION",
                      "value": "~4"
                    },
                    {
                      "name": "WEBSITE_NODE_DEFAULT_VERSION",
                      "value": "~14"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('aiKey')]"
                    },
                    {
                      "name": "FUNCTIONS_WORKER_RUNTIME",
                      "value": "[variables('functionWorkerRuntime')]"
                    },
                    {
                      "name": "CosmosDbConnectionString",
                      "value": "[parameters('cosmoscs')]"
                    },
                    {
                      "name": "serviceBusConnectionString",
                      "value": "[parameters('serviceBusConnectionString')]"
                    }
                  ],
                  "ftpsState": "FtpsOnly",
                  "minTlsVersion": "1.2"
                },
                "httpsOnly": true
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', format('plan-distributed-{0}-{1}-001', parameters('appName'), variables('shortLocation')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-backend-we-001', variables('projectName'))), 'Microsoft.Resources/deployments', format('ai-{0}', parameters('buildtag')))]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}-backend-eus-001', variables('projectName')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-data-{1}-001', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('dbName'), parameters('buildtag')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))), 'Microsoft.Resources/deployments', format('{0}-{1}', variables('sbName'), parameters('buildtag')))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('{0}-{1}', variables('sbName'), parameters('buildtag'))]",
      "resourceGroup": "[format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "sbName": {
            "value": "[variables('sbName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.13.1.58284",
              "templateHash": "9803910640076183633"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "westeurope",
              "metadata": {
                "description": "Location for resources. Default is West Europe."
              }
            },
            "sbName": {
              "type": "string",
              "metadata": {
                "description": "Event Grid name."
              }
            }
          },
          "variables": {
            "serviceBusEndpoint": "[format('{0}/AuthorizationRules/RootManageSharedAccessKey', resourceId('Microsoft.ServiceBus/namespaces', parameters('sbName')))]"
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-01-01-preview",
              "name": "[parameters('sbName')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}', parameters('sbName'), format('{0}-front-queue', parameters('sbName')))]",
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('sbName'))]"
              ]
            }
          ],
          "outputs": {
            "serviceBusConnectionString": {
              "type": "string",
              "value": "[listKeys(variables('serviceBusEndpoint'), '2022-01-01-preview').primaryConnectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('rg-{0}-message-{1}-002', variables('projectName'), variables('shortLocation')))]"
      ]
    }
  ]
}